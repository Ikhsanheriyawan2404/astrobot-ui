---
import Layout from '../layouts/Layout.astro';
const telegramBotUrl = 'https://t.me/your_bot_username';
const apiBaseUrl = import.meta.env.PUBLIC_API_BASE_URL;
---

<Layout>
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
    <p class="loading-text">Sedang verifikasi...</p>
  </div>

  <section class="hero">
    <div>
      <h1 class="hero-title">Asisten Bot Telegram buat hidup kamu makin rapih <span class="bang">!</span></h1>
      <p class="lead">Satu bot buat semua: pantau cuaca BMKG, pengingat sholat harian, reminder todo, sama pengingat harian biar jadwalmu nggak berantakan lagi.</p>
      <div style="margin-top:16px;display:flex;gap:12px;align-items:center">
        <a class="btn-sketch btn-primary" href={telegramBotUrl} target="_blank" rel="noopener">Coba di Telegram</a>
        <a id="open-home-btn" class="btn-sketch" href="/home" style="display:none">Buka Home</a>
        <span class="small">Auto jalan di iOS, Android, dan desktop</span>
      </div>
    </div>
    
  </section>

  <section id="fitur" class="section">
    <h2 style="margin:0 0 16px;font-family:Patrick Hand, system-ui;text-align:center">Fitur-fitur yang *No Cap*</h2>
    <div class="features">
      <div class="card">
        <h3 style="margin:0 0 6px">üå¶Ô∏è Pantau Cuaca BMKG</h3>
        <p class="small">Dapet update cuaca harian dari BMKG, jadi kamu nggak lagi keluar rumah pas langit udah siap nge-prank.</p>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px">üïå Pengingat Sholat Harian</h3>
        <p class="small">Bot bantu ngingetin waktu sholat harian kamu, otomatis disesuaikan dengan kota yang kamu pilih.</p>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px">‚úÖ Reminder Todo</h3>
        <p class="small">To-do list numpuk? Serahin ke bot. Tinggal catet, nanti dia yang nagih dengan lembut tapi tegas.</p>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px">üí¨ Pengingat Harian</h3>
        <p class="small">Quote pagi biar nggak baper sama hari Senin, plus pengingat kecil-kecil yang bikin kamu inget buat istirahat juga.</p>
      </div>
      <!-- <div class="card">
        <h3 style="margin:0 0 6px">üìñ Ayat & Hadis Harian</h3>
        <p class="small">Ayat Al-Qur'an atau hadis dikirim otomatis tiap pagi. Opsi tema Ramadan & pembelajaran Islam.</p>
      </div> -->
    </div>
  </section>

  <section id="cara" class="section">
    <div class="card">
      <h2 style="margin:0 0 8px;font-family:Patrick Hand, system-ui">Cara Pakai</h2>
      <p class="small">1) Klik tombol "Coba di Telegram" lalu ketik /start.<br/>2) Pilih kota dan fitur yang mau kamu aktifin.<br/>3) Tentuin jadwal notif, terus biarin bot yang kerja. Gampang.</p>
    </div>
  </section>

  <section id="faq" class="section">
    <div class="card">
      <h2 style="margin:0 0 12px;font-family:Patrick Hand, system-ui">FAQ</h2>
      <p class="small"><strong>T:</strong> Apakah perlu install aplikasi?<br/><strong>J:</strong> Tidak, cukup pakai Telegram yang sudah ada di HP kamu.</p>
      <p class="small" style="margin-top:8px"><strong>T:</strong> Bisa matiin beberapa opsi notif?<br/><strong>J:</strong> Bisa banget. Kamu yang pegang kendali, bot cuma nurut.</p>
      <p class="small" style="margin-top:8px"><strong>T:</strong> Data aman?<br/><strong>J:</strong> Semua data ngendon di chat Telegram kamu. Nggak dijual, nggak dipajang, nggak kemana-mana.</p>
    </div>
  </section>
</Layout>

<script define:vars={{ apiBaseUrl }}>
  (async function() {
    const params = new URLSearchParams(window.location.search);
    const refToken = params.get('ref');
    const loadingOverlay = document.getElementById('loading-overlay');
    const openHomeBtn = document.getElementById('open-home-btn');

    async function verifyToken(token, { save = false, redirectOnSuccess = false } = {}) {
      try {
        const response = await fetch(`${apiBaseUrl}/api/users/me`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const userData = await response.json();
          if (save) {
            localStorage.setItem('api_key', token);
            localStorage.setItem('user_data', JSON.stringify(userData));
          }
          if (openHomeBtn) openHomeBtn.style.display = 'inline-block';
          if (redirectOnSuccess) window.location.href = '/home';
          return true;
        }
      } catch (err) {
        console.error('verifyToken error', err);
      }
      return false;
    }

    // If ref present -> validate, save and redirect to /home
    if (refToken) {
      loadingOverlay.classList.remove('hidden');
      const ok = await verifyToken(refToken, { save: true, redirectOnSuccess: true });
      if (!ok) {
        loadingOverlay.classList.add('hidden');
        window.history.replaceState({}, document.title, '/');
      }
      return;
    }

    // No ref: check stored api_key and show "Buka Home" when valid
    const stored = localStorage.getItem('api_key');
    if (stored) {
      const ok = await verifyToken(stored, { save: true, redirectOnSuccess: false });
      if (!ok) {
        localStorage.removeItem('api_key');
        localStorage.removeItem('user_data');
        if (openHomeBtn) openHomeBtn.style.display = 'none';
      }
    }
  })();
</script>
