---
import Layout from '../layouts/Layout.astro';
const apiBaseUrl = import.meta.env.PUBLIC_API_BASE_URL;
---

<Layout>
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p class="loading-text">Memuat data...</p>
  </div>

  <div id="home-content" class="home-container" style="display:none">
    <!-- Header -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h1 class="user-greeting">Halo, <span id="user-name">...</span> <span class="iconify" data-icon="mdi:hand-wave" data-inline="false" style="vertical-align:middle;margin-left:6px"></span></h1>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Todo Section -->
      <div class="card feature-card" id="todo-section">
        <div class="card-header">
          <h2><span class="iconify" data-icon="mdi:check-circle-outline" data-inline="false" style="vertical-align:middle;margin-right:8px"></span>Todo List</h2>
          <div class="todo-header-actions">
            <span class="badge" id="todo-count">0</span>
            <button type="button" class="link-btn danger" id="clear-todos-btn">Hapus semua</button>
          </div>
        </div>

        <div class="todo-input-wrapper">
          <input 
            type="text" 
            id="new-todo-input" 
            class="todo-input" 
            placeholder="Tambah todo baru..."
            autocomplete="off"
          />
          <button id="add-todo-btn" class="btn-sketch btn-primary">Tambah</button>
        </div>

        <ul id="todo-list" class="todo-list">
          <!-- Todos will be rendered here -->
        </ul>

        <div id="empty-state" class="empty-state" style="display:none">
          <div class="empty-state-icon"><span class="iconify" data-icon="mdi:note-outline" data-inline="false"></span></div>
          <p class="empty-state-text">Belum ada todo. Yuk tambah yang pertama!</p>
        </div>
      </div>

      <!-- Jadwal Sholat Section -->
      <div class="card feature-card" id="sholat-section">
        <div class="card-header">
          <h2><span class="iconify" data-icon="mdi:mosque" data-inline="false" style="vertical-align:middle;margin-right:8px"></span>Jadwal Sholat</h2>
        </div>

        <div id="sholat-not-configured" class="setup-prompt">
          <div class="setup-icon"><span class="iconify" data-icon="mdi:map-marker" data-inline="false"></span></div>
          <p>Belum ada lokasi yang diatur</p>
          <p class="setup-hint">Atur lokasi untuk melihat jadwal sholat</p>
          <button class="btn-sketch btn-secondary open-sholat-setup">Atur Lokasi</button>
        </div>

        <div id="sholat-configured" style="display:none">
          <div class="location-badge">
            <span class="location-icon"><span class="iconify" data-icon="mdi:map-marker" data-inline="false"></span></span>
            <span id="sholat-location-name">-</span>
            <button class="btn-icon-small change-sholat-location" title="Ubah lokasi"><span class="iconify" data-icon="mdi:pencil" data-inline="false"></span></button>
          </div>
          <div class="prayer-times-grid" id="prayer-times">
            <!-- Prayer times will be rendered here -->
          </div>
          <div class="next-prayer-info" id="next-prayer-info">
            <!-- Next prayer info -->
          </div>
        </div>
      </div>

      <!-- Cuaca Section -->
      <div class="card feature-card" id="cuaca-section">
        <div class="card-header">
          <h2><span class="iconify" data-icon="mdi:weather-partly-cloudy" data-inline="false" style="vertical-align:middle;margin-right:8px"></span>Perkiraan Cuaca</h2>
        </div>

        <div id="cuaca-not-configured" class="setup-prompt">
          <div class="setup-icon"><span class="iconify" data-icon="mdi:map-marker" data-inline="false"></span></div>
          <p>Belum ada lokasi yang diatur</p>
          <p class="setup-hint">Atur lokasi untuk melihat perkiraan cuaca</p>
          <button class="btn-sketch btn-secondary open-cuaca-setup">Atur Lokasi</button>
        </div>

        <div id="cuaca-configured" style="display:none">
          <div class="location-badge">
            <span class="location-icon"><span class="iconify" data-icon="mdi:map-marker" data-inline="false"></span></span>
            <span id="cuaca-location-name">-</span>
            <button class="btn-icon-small change-cuaca-location" title="Ubah lokasi"><span class="iconify" data-icon="mdi:pencil" data-inline="false"></span></button>
          </div>
          <div class="weather-display" id="weather-display">
            <!-- Weather info will be rendered here -->
          </div>
          <div class="weather-forecast" id="weather-forecast">
            <!-- 3 day forecast -->
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Section -->
    <div class="card settings-card" style="margin-top:24px">
      <div class="card-header" style="cursor:pointer" id="settings-toggle">
        <h2><span class="iconify" data-icon="mdi:cog" data-inline="false" style="vertical-align:middle;margin-right:8px"></span>Pengaturan Notifikasi</h2>
        <span class="toggle-icon" id="settings-toggle-icon">▼</span>
      </div>

      <div id="settings-content" class="settings-content">
        <p class="settings-description">Atur notifikasi untuk membantu kamu tetap produktif dan tidak melewatkan hal penting.</p>

        <!-- Jadwal Sholat Notification -->
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">
              <span class="setting-icon"><span class="iconify" data-icon="mdi:mosque" data-inline="false"></span></span>
              <span>Notifikasi Jadwal Sholat</span>
            </div>
            <p class="setting-desc">Agar selalu ingat kewajiban setiap waktunya. Notifikasi dikirim setiap waktu masuk.</p>
          </div>
          <div class="setting-controls">
            <label class="toggle-switch">
              <input type="checkbox" id="notif-sholat" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        
        <!-- Cuaca Notification -->
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">
              <span class="setting-icon"><span class="iconify" data-icon="mdi:weather-partly-cloudy" data-inline="false"></span></span>
              <span>Notifikasi Cuaca</span>
            </div>
            <p class="setting-desc">Untuk jaga-jaga jika ada kegiatan di luar rumah. Diingatkan setiap hari.</p>
          </div>
          <div class="setting-controls">
            <label class="toggle-switch">
              <input type="checkbox" id="notif-cuaca" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-time-picker" id="cuaca-time-picker">
          <label>Jam pengingat:</label>
          <input type="time" id="cuaca-notif-time" value="06:00">
        </div>
        
        <!-- Todo Notification -->
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">
              <span class="setting-icon"><span class="iconify" data-icon="mdi:clipboard-list" data-inline="false"></span></span>
              <span>Notifikasi Todo</span>
            </div>
            <p class="setting-desc">Diingatkan setiap hari di awal hari tentang apa saja yang harus dikerjakan.</p>
          </div>
          <div class="setting-controls">
            <label class="toggle-switch">
              <input type="checkbox" id="notif-todo" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-time-picker" id="todo-time-picker">
          <label>Jam pengingat:</label>
          <input type="time" id="todo-notif-time" value="07:00">
        </div>

        <!-- Motivasi Notification -->
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">
              <span class="setting-icon"><span class="iconify" data-icon="mdi:lightbulb" data-inline="false"></span></span>
              <span>Notifikasi Motivasi</span>
            </div>
            <p class="setting-desc">Untuk selalu semangat dan termotivasi menjalani hari.</p>
          </div>
          <div class="setting-controls">
            <label class="toggle-switch">
              <input type="checkbox" id="notif-motivasi" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-time-picker" id="motivasi-time-picker">
          <label>Jam pengingat:</label>
          <input type="time" id="motivasi-notif-time" value="08:00">
        </div>

        <button id="save-settings-btn" class="btn-sketch btn-primary" style="margin-top:16px;width:100%"><span class="iconify" data-icon="mdi:content-save-outline" data-inline="false" style="vertical-align:middle;margin-right:8px"></span>Simpan Pengaturan</button>
      </div>
    </div>
  </div>

  <!-- Modal: Setup Jadwal Sholat -->
  <div id="modal-sholat" class="modal-overlay" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <h3><span class="iconify" data-icon="mdi:mosque" data-inline="false" style="vertical-align:middle;margin-right:8px"></span>Atur Lokasi Jadwal Sholat</h3>
        <button class="modal-close" data-modal="modal-sholat">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-hint">Cari Kabupaten/Kota untuk mendapatkan jadwal sholat yang akurat.</p>
        <div class="search-wrapper">
          <input 
            type="text" 
            id="search-city" 
            class="search-input" 
            placeholder="Cari kab/kota... (contoh: Cirebon)"
            autocomplete="off"
          />
          <div class="search-loading" id="search-city-loading" style="display:none">
            <span class="spinner-small"></span>
          </div>
        </div>
        <ul id="city-results" class="search-results">
          <!-- Search results -->
        </ul>
        <div id="selected-city" class="selected-location" style="display:none">
          <span class="selected-icon"><span class="iconify" data-icon="mdi:check" data-inline="false"></span></span>
          <span id="selected-city-name">-</span>
          <button class="btn-icon-small clear-city" title="Hapus"><span class="iconify" data-icon="mdi:close" data-inline="false"></span></button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-sketch btn-secondary" data-modal="modal-sholat">Batal</button>
        <button id="save-sholat-location" class="btn-sketch btn-primary" disabled>Simpan</button>
      </div>
    </div>
  </div>

  <!-- Modal: Setup Cuaca -->
  <div id="modal-cuaca" class="modal-overlay" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <h3><span class="iconify" data-icon="mdi:weather-partly-cloudy" data-inline="false" style="vertical-align:middle;margin-right:8px"></span>Atur Lokasi Cuaca</h3>
        <button class="modal-close" data-modal="modal-cuaca">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-hint">Cari wilayah (kelurahan/desa) untuk mendapatkan perkiraan cuaca yang akurat.</p>
        <div class="search-wrapper">
          <input 
            type="text" 
            id="search-region" 
            class="search-input" 
            placeholder="Cari wilayah... (contoh: Kempek)"
            autocomplete="off"
          />
          <div class="search-loading" id="search-region-loading" style="display:none">
            <span class="spinner-small"></span>
          </div>
        </div>
        <ul id="region-results" class="search-results">
          <!-- Search results -->
        </ul>
        <div id="selected-region" class="selected-location" style="display:none">
          <span class="selected-icon"><span class="iconify" data-icon="mdi:check" data-inline="false"></span></span>
          <span id="selected-region-name">-</span>
          <button class="btn-icon-small clear-region" title="Hapus"><span class="iconify" data-icon="mdi:close" data-inline="false"></span></button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-sketch btn-secondary" data-modal="modal-cuaca">Batal</button>
        <button id="save-cuaca-location" class="btn-sketch btn-primary" disabled>Simpan</button>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ apiBaseUrl }}>
  // ===== STATE =====
  let todos = [];
  let editingId = null;
  let apiKey = null;
  let userData = null;

  // Location state
  let selectedCity = null;    // For Sholat
  let selectedRegion = null;  // For Cuaca

  // Settings state (loaded from localStorage)
  let settings = {
    sholatLocation: null,
    cuacaLocation: null,
    notifications: {
      todo: { enabled: true, time: '07:00' },
      sholat: { enabled: true },
      cuaca: { enabled: true, time: '06:00' },
      motivasi: { enabled: true, time: '08:00' }
    }
  };

  // Dummy data for prayer times
  const dummyPrayerTimes = {
    subuh: '04:32',
    dzuhur: '11:56',
    ashar: '15:12',
    maghrib: '17:58',
    isya: '19:10'
  };

  // Dummy weather data
  const dummyWeather = {
    current: {
      temp: 28,
      desc: 'Berawan',
      icon: '<span class="iconify" data-icon="mdi:weather-partly-cloudy" data-inline="false"></span>',
      humidity: 75,
      wind: 12
    },
    forecast: [
      { day: 'Besok', icon: '<span class="iconify" data-icon="mdi:weather-sunny" data-inline="false"></span>', temp: '27°' },
      { day: 'Lusa', icon: '<span class="iconify" data-icon="mdi:weather-rainy" data-inline="false"></span>', temp: '25°' },
      { day: 'Sab', icon: '<span class="iconify" data-icon="mdi:weather-partly-cloudy" data-inline="false"></span>', temp: '28°' }
    ]
  };

  // Motivation quotes
  const motivationQuotes = [
    "Setiap hari adalah kesempatan baru untuk menjadi versi terbaik dari dirimu.",
    "Kebahagiaan tidak datang dari apa yang kita miliki, tapi dari rasa syukur atas apa yang ada.",
    "Jangan menunggu kesempatan, ciptakanlah kesempatan itu sendiri.",
    "Kegagalan adalah kesempatan untuk memulai lagi dengan lebih cerdas.",
    "Perjalanan seribu mil dimulai dengan satu langkah.",
    "Bukan tentang seberapa cepat kamu berlari, tapi seberapa konsisten kamu melangkah.",
    "Hari ini adalah hari terbaik untuk memulai sesuatu yang baru.",
    "Kesuksesan adalah hasil dari persiapan, kerja keras, dan belajar dari kegagalan."
  ];

  // ===== DOM ELEMENTS =====
  const loadingOverlay = document.getElementById('loading-overlay');
  const homeContent = document.getElementById('home-content');
  const userNameEl = document.getElementById('user-name');
  const todoListEl = document.getElementById('todo-list');
  const emptyStateEl = document.getElementById('empty-state');
  const newTodoInput = document.getElementById('new-todo-input');
  const addTodoBtn = document.getElementById('add-todo-btn');
  const todoCountEl = document.getElementById('todo-count');
  const clearTodosBtn = document.getElementById('clear-todos-btn');

  // Welcome card
  const welcomeCard = document.getElementById('welcome-card');
  const setupBtn = document.getElementById('setup-btn');

  // Sholat elements
  const sholatNotConfigured = document.getElementById('sholat-not-configured');
  const sholatConfigured = document.getElementById('sholat-configured');
  const sholatLocationName = document.getElementById('sholat-location-name');
  const prayerTimesEl = document.getElementById('prayer-times');
  const nextPrayerInfo = document.getElementById('next-prayer-info');

  // Cuaca elements
  const cuacaNotConfigured = document.getElementById('cuaca-not-configured');
  const cuacaConfigured = document.getElementById('cuaca-configured');
  const cuacaLocationName = document.getElementById('cuaca-location-name');
  const weatherDisplay = document.getElementById('weather-display');
  const weatherForecast = document.getElementById('weather-forecast');

  // Settings elements
  const settingsToggle = document.getElementById('settings-toggle');
  const settingsToggleIcon = document.getElementById('settings-toggle-icon');
  const settingsContent = document.getElementById('settings-content');
  const saveSettingsBtn = document.getElementById('save-settings-btn');

  // Notification toggles
  const notifTodo = document.getElementById('notif-todo');
  const notifSholat = document.getElementById('notif-sholat');
  const notifCuaca = document.getElementById('notif-cuaca');
  const notifMotivasi = document.getElementById('notif-motivasi');

  // Time pickers
  const todoTimePicker = document.getElementById('todo-time-picker');
  const cuacaTimePicker = document.getElementById('cuaca-time-picker');
  const motivasiTimePicker = document.getElementById('motivasi-time-picker');
  const todoNotifTime = document.getElementById('todo-notif-time');
  const cuacaNotifTime = document.getElementById('cuaca-notif-time');
  const motivasiNotifTime = document.getElementById('motivasi-notif-time');

  // Modals
  const modalSholat = document.getElementById('modal-sholat');
  const modalCuaca = document.getElementById('modal-cuaca');
  const searchCity = document.getElementById('search-city');
  const searchCityLoading = document.getElementById('search-city-loading');
  const cityResults = document.getElementById('city-results');
  const selectedCityEl = document.getElementById('selected-city');
  const selectedCityName = document.getElementById('selected-city-name');
  const saveSholatLocation = document.getElementById('save-sholat-location');

  const searchRegion = document.getElementById('search-region');
  const searchRegionLoading = document.getElementById('search-region-loading');
  const regionResults = document.getElementById('region-results');
  const selectedRegionEl = document.getElementById('selected-region');
  const selectedRegionName = document.getElementById('selected-region-name');
  const saveCuacaLocation = document.getElementById('save-cuaca-location');

  // ===== UTILITY FUNCTIONS =====
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Normalize server todo shape to include `completed` (backend uses `deleted_at` as soft-delete)
  function normalizeTodo(todo) {
    if (!todo) return todo;
    return Object.assign({}, todo, { completed: !!todo.deleted_at });
  }

  // ===== SETTINGS FUNCTIONS =====
  function loadSettings() {
    const saved = localStorage.getItem('app_settings');
    if (saved) {
      settings = JSON.parse(saved);
    }
    applySettingsToUI();
  }

  function saveSettings() {
    localStorage.setItem('app_settings', JSON.stringify(settings));
  }

  // Fetch settings from backend and merge/apply
  async function fetchUserSettings() {
    try {
      const res = await fetch(`${apiBaseUrl}/api/settings`, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        }
      });

      if (!res.ok) {
        console.warn('fetchUserSettings: server returned', res.status);
        return null;
      }

      const body = await res.json();
      const data = body.data || null;
      if (!data) return null;

      // Map API shape to local `settings` shape
      settings = settings || {};
      settings.sholatLocation = settings.sholatLocation || null;
      settings.cuacaLocation = settings.cuacaLocation || null;
      settings.notifications = settings.notifications || {};

      settings.notifications.motivasi = {
        enabled: !!(data.motivation && data.motivation.enabled),
        time: (data.motivation && data.motivation.time) || settings.notifications.motivasi?.time || '08:00'
      };
      settings.notifications.todo = {
        enabled: !!(data.todo && data.todo.enabled),
        time: (data.todo && data.todo.time) || settings.notifications.todo?.time || '07:00'
      };
      settings.notifications.cuaca = {
        enabled: !!(data.weather && data.weather.enabled),
        time: (data.weather && data.weather.time) || settings.notifications.cuaca?.time || '06:00',
        code: data.weather && data.weather.code
      };
      settings.notifications.sholat = {
        enabled: !!(data.prayer && data.prayer.enabled),
        code: data.prayer && data.prayer.code
      };
      settings.timezone = data.timezone || settings.timezone || 'Asia/Jakarta';

      saveSettings();
      applySettingsToUI();
      return data;
    } catch (err) {
      console.warn('fetchUserSettings failed', err);
      return null;
    }
  }

  async function updateUserSettings() {
    // build payload in API shape
    const payload = {
      motivation: { enabled: !!settings.notifications.motivasi.enabled, time: settings.notifications.motivasi.time },
      todo: { enabled: !!settings.notifications.todo.enabled, time: settings.notifications.todo.time },
      weather: { enabled: !!settings.notifications.cuaca.enabled, time: settings.notifications.cuaca.time, code: settings.notifications.cuaca.code || '' },
      prayer: { enabled: !!settings.notifications.sholat.enabled, code: settings.notifications.sholat.code || '' },
      timezone: settings.timezone || 'Asia/Jakarta'
    };

    try {
      const res = await fetch(`${apiBaseUrl}/api/settings`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Server returned ${res.status}: ${text}`);
      }

      const body = await res.json();
      // merge returned data if provided
      if (body && body.data) {
        await fetchUserSettings();
      }
      return body;
    } catch (err) {
      console.error('updateUserSettings failed', err);
      throw err;
    }
  }

  function applySettingsToUI() {
    // Notification toggles
    notifTodo.checked = settings.notifications.todo.enabled;
    notifSholat.checked = settings.notifications.sholat.enabled;
    notifCuaca.checked = settings.notifications.cuaca.enabled;
    notifMotivasi.checked = settings.notifications.motivasi.enabled;

    // Time pickers
    todoNotifTime.value = settings.notifications.todo.time;
    cuacaNotifTime.value = settings.notifications.cuaca.time;
    motivasiNotifTime.value = settings.notifications.motivasi.time;

    // Time picker visibility
    updateTimePickerVisibility();

    // Location states
    // Prefer explicit location objects saved locally
    if (settings.sholatLocation) {
      selectedCity = settings.sholatLocation;
      // we can render immediately when we have a full object
      renderSholatConfigured();
    } else if (settings.notifications && settings.notifications.sholat && settings.notifications.sholat.code) {
      // If server provided only a code and no local object, set placeholder without showing code
      selectedCity = { id: settings.notifications.sholat.code, name: null, _codeOnly: true };
      // do NOT render yet; we'll fetch the human-readable name
    }

    if (settings.cuacaLocation) {
      selectedRegion = settings.cuacaLocation;
      renderCuacaConfigured();
    } else if (settings.notifications && settings.notifications.cuaca && settings.notifications.cuaca.code) {
      selectedRegion = { id: settings.notifications.cuaca.code, name: null, _codeOnly: true };
      // await fetch to get name before rendering
    }
  }

  function updateTimePickerVisibility() {
    todoTimePicker.classList.toggle('hidden', !notifTodo.checked);
    cuacaTimePicker.classList.toggle('hidden', !notifCuaca.checked);
    motivasiTimePicker.classList.toggle('hidden', !notifMotivasi.checked);
  }

  // ===== AUTH FUNCTIONS =====
  async function checkAuth() {
    apiKey = localStorage.getItem('api_key');
    const storedUserData = localStorage.getItem('user_data');

    if (!apiKey) {
      window.location.href = '/';
      return false;
    }

    try {
      const response = await fetch(`${apiBaseUrl}/api/users/me`, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        }
      });

      if (!response.ok) {
        localStorage.removeItem('api_key');
        localStorage.removeItem('user_data');
        window.location.href = '/';
        return false;
      }

      userData = (await response.json()).data;
      localStorage.setItem('user_data', JSON.stringify(userData));
      return true;
    } catch (error) {
      console.error('Auth check failed:', error);
      if (storedUserData) {
        userData = JSON.parse(storedUserData);
        return true;
      }
      window.location.href = '/';
      return false;
    }
  }

  // ===== TODO FUNCTIONS =====
  async function fetchTodos() {
    try {
      const response = await fetch(`${apiBaseUrl}/api/todos`, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        }
      });

      if (response.ok) {
        const body = await response.json();
        const data = body.data || [];
        todos = data.map(normalizeTodo);
      } else {
        todos = [];
      }
    } catch (error) {
      console.error('Failed to fetch todos:', error);
      const cachedTodos = localStorage.getItem('todos');
      todos = cachedTodos ? JSON.parse(cachedTodos) : [];
    }
    renderTodos();
  }

  async function createTodo(title) {
    try {
      const response = await fetch(`${apiBaseUrl}/api/todos`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({ title, completed: false })
      });

      if (response.ok) {
        const body = await response.json();
        const newTodo = normalizeTodo(body.data);
        todos.unshift(newTodo);
      } else {
        const newTodo = {
          id: Date.now(),
          title,
          completed: false,
          created_at: new Date().toISOString()
        };
        todos.unshift(newTodo);
      }
    } catch (error) {
      console.error('Failed to create todo:', error);
      const newTodo = {
        id: Date.now(),
        title,
        completed: false,
        created_at: new Date().toISOString()
      };
      todos.unshift(newTodo);
    }
    saveTodosLocally();
    renderTodos();
  }

  function findTodoIndex(id) {
    const targetId = String(id);
    return todos.findIndex(t => String(t.id) === targetId);
  }

  async function updateTodo(id, updates) {
    const todoIndex = findTodoIndex(id);
    if (todoIndex === -1) return;

    try {
      const response = await fetch(`${apiBaseUrl}/api/todos/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify(updates)
      });

      if (response.ok) {
        const body = await response.json();
        const updatedTodo = normalizeTodo(body.data);
        todos[todoIndex] = updatedTodo;
      } else {
        todos[todoIndex] = { ...todos[todoIndex], ...updates };
      }
    } catch (error) {
      console.error('Failed to update todo:', error);
      todos[todoIndex] = { ...todos[todoIndex], ...updates };
    }
    saveTodosLocally();
    renderTodos();
  }

  async function toggleTodo(id) {
    const todoIndex = findTodoIndex(id);
    if (todoIndex === -1) {
      return;
    }
    const todo = todos[todoIndex];

      if (todo.deleted_at) {
        console.warn('toggleTodo: todo has deleted_at flag; attempting toggle anyway for robustness');
      }

    const currentCompleted = !!todo.completed;
    const newCheck = !currentCompleted;

    try {
      const response = await fetch(`${apiBaseUrl}/api/todos/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({ check: newCheck })
      });

      if (response.ok) {
        const body = await response.json();
        const updated = body.data ? normalizeTodo(body.data) : { ...todo, completed: newCheck };
        todos[todoIndex] = updated;
      } else {
        todos[todoIndex] = { ...todo, completed: newCheck };
      }
    } catch (err) {
      console.error('Failed to toggle todo:', err);
      todos[todoIndex] = { ...todo, completed: newCheck };
    }

    saveTodosLocally();
    renderTodos();
  }

  function saveTodosLocally() {
    localStorage.setItem('todos', JSON.stringify(todos));
  }

  async function deleteAllTodos() {
    if (!clearTodosBtn) return;
    const confirmed = window.confirm('Hapus semua todo? Data yang sudah dihapus tidak bisa dikembalikan.');
    if (!confirmed) return;

    const originalLabel = clearTodosBtn.textContent;
    clearTodosBtn.disabled = true;
    clearTodosBtn.textContent = 'Menghapus...';

    try {
      const response = await fetch(`${apiBaseUrl}/api/todos`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        }
      });

      if (!response.ok) {
        throw new Error('Failed to delete todos');
      }

      todos = [];
      saveTodosLocally();
      renderTodos();
    } catch (error) {
      console.error('Failed to delete all todos:', error);
      alert('Gagal menghapus semua todo. Coba lagi.');
    } finally {
      clearTodosBtn.disabled = false;
      clearTodosBtn.textContent = originalLabel;
    }
  }

  function renderTodos() {
    const activeTodos = todos.filter(t => !t.completed && !t.deleted_at);
    todoCountEl.textContent = activeTodos.length;

    if (todos.length === 0) {
      todoListEl.innerHTML = '';
      emptyStateEl.style.display = 'block';
      return;
    }

    emptyStateEl.style.display = 'none';
    
    todoListEl.innerHTML = todos.map(todo => {
      const todoId = String(todo.id);
      const isDeleted = !!todo.deleted_at;
        const isChecked = !!todo.completed;
      const itemClass = isChecked ? 'completed' : '';
      const checkedAttr = isChecked ? ' checked="checked"' : '';
      const dataActionAttr = '';
      const isEditing = editingId !== null && String(editingId) === todoId;

      const titleEsc = escapeHtml(todo.title || '');
      const contentHtml = isEditing
        ? '<input type="text" class="todo-title-input" value="' + titleEsc + '" data-action="edit-input" />'
        : '<span class="todo-title" data-action="edit">' + titleEsc + '</span>';

      const actionsHtml = isEditing
        ? '<button class="btn-icon" data-action="save" title="Simpan"><span class="iconify" data-icon="mdi:content-save-outline" data-inline="false"></span></button>'
        : '<button class="btn-icon" data-action="edit" title="Edit"><span class="iconify" data-icon="mdi:pencil" data-inline="false"></span></button>';

      return `
      <li class="todo-item ${itemClass}" data-id="${todoId}">
        <input 
          type="checkbox" 
          class="todo-checkbox" 
          ${checkedAttr}
          ${dataActionAttr}
        />
        <div class="todo-content">
          ${contentHtml}
        </div>
        <div class="todo-actions">
          ${actionsHtml}
        </div>
      </li>
    `;
    }).join('');
  }

  // ===== SHOLAT FUNCTIONS =====
  function renderSholatConfigured() {
    if (!selectedCity) return;

    // Minimal display: show only stored location and a short note with source link.
    sholatNotConfigured.style.display = 'none';
    sholatConfigured.style.display = 'block';
    // Show name and, if available, the server 'code' for this prayer setting
    sholatLocationName.textContent = selectedCity.name;

    // Hide detailed elements
    prayerTimesEl.innerHTML = '';
    prayerTimesEl.style.display = 'none';

    nextPrayerInfo.innerHTML = '';
    // remove previous simple note if present
    const prevSholat = nextPrayerInfo.querySelector('.sholat-simple-note');
    if (prevSholat) prevSholat.remove();
    const sholatNote = document.createElement('div');
    sholatNote.className = 'info-note blue sholat-simple-note';
    sholatNote.innerHTML = `
      <div>
        <div>Notifikasi akan dikirim pada waktunya di Telegram.</div>
        <div class="copyright-note"><span class="iconify" data-icon="mdi:copyright" data-inline="false"></span> Sumber: <a class="source-link" href="https://api.myquran.com/" target="_blank" rel="noopener">myQuran (API v3)</a></div>
      </div>
    `;
    nextPrayerInfo.appendChild(sholatNote);
  }

  // ===== CUACA FUNCTIONS =====
  function renderCuacaConfigured() {
    if (!selectedRegion) return;

    // Minimal display: show only stored location and a short note with source link.
    cuacaNotConfigured.style.display = 'none';
    cuacaConfigured.style.display = 'block';
    cuacaLocationName.textContent = selectedRegion.name;

    weatherDisplay.innerHTML = '';
    weatherDisplay.style.display = 'none';
    weatherForecast.innerHTML = '';
    weatherForecast.style.display = 'none';

    // Remove existing simple note if present
    const prev = cuacaConfigured.querySelector('.cuaca-simple-note');
    if (prev) prev.remove();

    const cuacaNote = document.createElement('div');
    cuacaNote.className = 'info-note blue cuaca-simple-note';
    cuacaNote.innerHTML = `
      <div>
        <div>Notifikasi akan dikirim pada waktunya di Telegram.</div>
        <div class="copyright-note"><span class="iconify" data-icon="mdi:copyright" data-inline="false"></span> Sumber: <a class="source-link" href="https://data.bmkg.go.id/prakiraan-cuaca/" target="_blank" rel="noopener">BMKG</a> (Badan Meteorologi, Klimatologi, dan Geofisika)</div>
      </div>
    `;
    cuacaConfigured.appendChild(cuacaNote);
  }

  // ===== SEARCH FUNCTIONS (REAL API) =====
  async function searchCities(query) {
    if (!query || query.length < 2) {
      cityResults.innerHTML = '';
      return;
    }

    searchCityLoading.style.display = 'block';

    try {
      const response = await fetch(`${apiBaseUrl}/api/city?q=${encodeURIComponent(query)}`, {
        headers: { 'Content-Type': 'application/json' }
      });

      if (response.ok) {
        const data = await response.json();
        const results = data.data || [];
        
        if (results.length === 0) {
          cityResults.innerHTML = '<li class="no-results">Tidak ditemukan hasil</li>';
        } else {
          cityResults.innerHTML = results.map(city => `
            <li class="search-result-item" data-id="${city.code}" data-name="${escapeHtml(city.name)}">
              <div class="result-name">${escapeHtml(city.name)}</div>
              <div class="result-detail">${escapeHtml(city.province || '')}</div>
            </li>
          `).join('');
        }
      } else {
        cityResults.innerHTML = '<li class="no-results">Gagal mencari data</li>';
      }
    } catch (error) {
      console.error('Search city failed:', error);
      cityResults.innerHTML = '<li class="no-results">Gagal mencari data</li>';
    }

    searchCityLoading.style.display = 'none';
  }

  async function searchRegions(query) {
    if (!query || query.length < 2) {
      regionResults.innerHTML = '';
      return;
    }

    searchRegionLoading.style.display = 'block';

    try {
      const response = await fetch(`${apiBaseUrl}/api/region?q=${encodeURIComponent(query)}`, {
        headers: { 'Content-Type': 'application/json' }
      });

      if (response.ok) {
        const data = await response.json();
        const results = data.data || [];
        
        if (results.length === 0) {
          regionResults.innerHTML = '<li class="no-results">Tidak ditemukan hasil</li>';
        } else {
          regionResults.innerHTML = results.map(region => `
            <li class="search-result-item" data-id="${region.code}" data-name="${escapeHtml(region.name)}">
              <div class="result-name">${escapeHtml(region.name)}</div>
              <div class="result-detail">${escapeHtml(region.full_path || region.district || '')}</div>
            </li>
          `).join('');
        }
      } else {
        regionResults.innerHTML = '<li class="no-results">Gagal mencari data</li>';
      }
    } catch (error) {
      console.error('Search region failed:', error);
      regionResults.innerHTML = '<li class="no-results">Gagal mencari data</li>';
    }

    searchRegionLoading.style.display = 'none';
  }

  // Debounced search
  const debouncedSearchCities = debounce(searchCities, 300);
  const debouncedSearchRegions = debounce(searchRegions, 300);

  // Fetch human-readable city detail by code
  async function getCityDetail(code) {
    if (!code) return null;
    try {
      const res = await fetch(`${apiBaseUrl}/api/city/${encodeURIComponent(code)}`, {
        headers: {
          'Content-Type': 'application/json',
          ...(apiKey ? { 'Authorization': `Bearer ${apiKey}` } : {})
        }
      });
      if (!res.ok) return null;
      const body = await res.json();
      return body?.data?.name || null;
    } catch (err) {
      console.warn('getCityDetail failed', err);
      return null;
    }
  }

  // Fetch human-readable region detail by code
  async function getRegionDetail(code) {
    if (!code) return null;
    try {
      const res = await fetch(`${apiBaseUrl}/api/region/${encodeURIComponent(code)}`, {
        headers: {
          'Content-Type': 'application/json',
          ...(apiKey ? { 'Authorization': `Bearer ${apiKey}` } : {})
        }
      });
      if (!res.ok) return null;
      const body = await res.json();
      return body?.data?.name || null;
    } catch (err) {
      console.warn('getRegionDetail failed', err);
      return null;
    }
  }

  // When no local settings exist, fetch names for code-only locations and render
  async function populateLocationNamesFromCodes() {
    try {
      // Sholat
      if ((!settings.sholatLocation || !settings.sholatLocation.name) && settings.notifications?.sholat?.code) {
        const code = settings.notifications.sholat.code;
        // set placeholder id if not set
        if (!selectedCity) selectedCity = { id: code, name: null, _codeOnly: true };
        const name = await getCityDetail(code);
        selectedCity.name = name || code;
        renderSholatConfigured();
      }

      // Cuaca
      if ((!settings.cuacaLocation || !settings.cuacaLocation.name) && settings.notifications?.cuaca?.code) {
        const code = settings.notifications.cuaca.code;
        if (!selectedRegion) selectedRegion = { id: code, name: null, _codeOnly: true };
        const name = await getRegionDetail(code);
        selectedRegion.name = name || code;
        renderCuacaConfigured();
      }
    } catch (err) {
      console.warn('populateLocationNamesFromCodes failed', err);
    }
  }

  // ===== MODAL FUNCTIONS =====
  function openModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    // Reset search state
    if (modalId === 'modal-sholat') {
      searchCity.value = '';
      cityResults.innerHTML = '';
      if (!settings.sholatLocation) {
        selectedCityEl.style.display = 'none';
        selectedCity = null;
        saveSholatLocation.disabled = true;
      }
    } else if (modalId === 'modal-cuaca') {
      searchRegion.value = '';
      regionResults.innerHTML = '';
      if (!settings.cuacaLocation) {
        selectedRegionEl.style.display = 'none';
        selectedRegion = null;
        saveCuacaLocation.disabled = true;
      }
    }
  }

  // ===== EVENT HANDLERS =====
  function handleTodoClick(e) {
    // find the nearest element that carries a data-action attribute
    const actionEl = e.target.closest('[data-action]');
    if (!actionEl) return;

    const action = actionEl.dataset.action;
    const todoItem = actionEl.closest('.todo-item');
    if (!todoItem) return;

    const id = todoItem.dataset.id;

    switch (action) {
      case 'toggle':
        toggleTodo(id);
        break;
      case 'edit':
        editingId = id;
        renderTodos();
        setTimeout(() => {
          const newItem = todoListEl.querySelector(`[data-id="${id}"]`);
          const input = newItem ? newItem.querySelector('.todo-title-input') : null;
          if (input) {
            input.focus();
            input.select();
          }
        }, 0);
        break;
      case 'save':
        const saveInput = todoItem.querySelector('.todo-title-input');
        if (saveInput && saveInput.value.trim()) {
          updateTodo(id, { title: saveInput.value.trim() });
        }
        editingId = null;
        renderTodos();
        break;
    }
  }

  function handleKeyDown(e) {
    if (e.key === 'Enter') {
      const input = e.target;
      if (input.dataset.action === 'edit-input') {
        const todoItem = input.closest('.todo-item');
        const id = todoItem.dataset.id;
        if (input.value.trim()) {
          updateTodo(id, { title: input.value.trim() });
        }
        editingId = null;
      }
    } else if (e.key === 'Escape') {
      editingId = null;
      renderTodos();
    }
  }

  function handleAddTodo() {
    const title = newTodoInput.value.trim();
    if (title) {
      createTodo(title);
      newTodoInput.value = '';
      newTodoInput.focus();
    }
  }

  function handleSaveSettings() {
    // read UI values into settings
    settings.notifications.todo.enabled = notifTodo.checked;
    settings.notifications.todo.time = todoNotifTime.value;
    settings.notifications.sholat.enabled = notifSholat.checked;
    settings.notifications.cuaca.enabled = notifCuaca.checked;
    settings.notifications.cuaca.time = cuacaNotifTime.value;
    settings.notifications.motivasi.enabled = notifMotivasi.checked;
    settings.notifications.motivasi.time = motivasiNotifTime.value;

    // UI: show saving state
    saveSettingsBtn.disabled = true;
    saveSettingsBtn.innerHTML = '<span class="iconify spin" data-icon="mdi:loading" data-inline="false" style="vertical-align:middle;margin-right:8px"></span>Menyimpan...';

    // Persist locally first
    saveSettings();

    // Send to backend
    updateUserSettings().then(() => {
      saveSettingsBtn.innerHTML = '<span class="iconify" data-icon="mdi:check-circle" data-inline="false" style="vertical-align:middle;margin-right:8px"></span> Tersimpan!';
    }).catch(() => {
      saveSettingsBtn.innerHTML = '<span class="iconify" data-icon="mdi:alert-circle" data-inline="false" style="vertical-align:middle;margin-right:8px"></span> Gagal';
    }).finally(() => {
      setTimeout(() => {
        saveSettingsBtn.innerHTML = '<span class="iconify" data-icon="mdi:content-save-outline" data-inline="false" style="vertical-align:middle;margin-right:8px"></span>Simpan Pengaturan';
        saveSettingsBtn.disabled = false;
      }, 1500);
    });
  }

  // ===== INITIALIZE =====
  async function init() {
    const isAuthenticated = await checkAuth();
    if (!isAuthenticated) return;

    // Determine if local settings exist; if not, we'll populate names from server codes
    const hadLocalSettings = !!localStorage.getItem('app_settings');

    // Load local settings fast, then try to fetch server settings to override
    loadSettings();
    await fetchUserSettings();

    // If no local settings previously, populate human-readable names for any code-only locations
    if (!hadLocalSettings) {
      await populateLocationNamesFromCodes();
    }

    // Show content
    userNameEl.textContent = userData.name || 'User';
    loadingOverlay.classList.add('hidden');
    homeContent.style.display = 'block';

    // Fetch todos
    await fetchTodos();

    // ===== EVENT LISTENERS =====

    // Todo
    todoListEl.addEventListener('click', handleTodoClick);
    todoListEl.addEventListener('keydown', handleKeyDown);
    todoListEl.addEventListener('change', (e) => {
      if (e.target.classList.contains('todo-checkbox')) {
        const todoItem = e.target.closest('.todo-item');
        if (todoItem) {
          const id = todoItem.dataset.id;
          toggleTodo(id);
        }
      }
    });
    addTodoBtn.addEventListener('click', handleAddTodo);
    newTodoInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleAddTodo();
    });

    clearTodosBtn?.addEventListener('click', deleteAllTodos);

    // Settings toggle
    settingsToggle.addEventListener('click', () => {
      settingsContent.classList.toggle('collapsed');
      settingsToggleIcon.classList.toggle('collapsed');
    });

    // Notification toggles - update time picker visibility
    notifTodo.addEventListener('change', updateTimePickerVisibility);
    notifCuaca.addEventListener('change', updateTimePickerVisibility);
    notifMotivasi.addEventListener('change', updateTimePickerVisibility);

    // Save settings
    saveSettingsBtn.addEventListener('click', handleSaveSettings);

    // Open sholat modal
    document.querySelectorAll('.open-sholat-setup, .change-sholat-location').forEach(btn => {
      btn.addEventListener('click', () => openModal('modal-sholat'));
    });

    // Open cuaca modal
    document.querySelectorAll('.open-cuaca-setup, .change-cuaca-location').forEach(btn => {
      btn.addEventListener('click', () => openModal('modal-cuaca'));
    });

    // Close modals
    document.querySelectorAll('.modal-close, .modal-footer .btn-secondary').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const modalId = e.target.dataset.modal;
        if (modalId) closeModal(modalId);
      });
    });

    // Close modal on backdrop click
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal(modal.id);
      });
    });

    // City search
    searchCity.addEventListener('input', (e) => {
      debouncedSearchCities(e.target.value);
    });

    // City result selection
    cityResults.addEventListener('click', (e) => {
      const item = e.target.closest('.search-result-item');
      console.log({item}, item.dataset)
      if (item) {
        selectedCity = {
          id: item.dataset.id,
          name: item.dataset.name
        };
        selectedCityName.textContent = selectedCity.name;
        selectedCityEl.style.display = 'flex';
        cityResults.innerHTML = '';
        searchCity.value = '';
        saveSholatLocation.disabled = false;
      }
    });

    // Clear city selection
    document.querySelector('.clear-city')?.addEventListener('click', () => {
      selectedCity = null;
      selectedCityEl.style.display = 'none';
      saveSholatLocation.disabled = true;
    });

    // Save sholat location -> POST /api/city
    saveSholatLocation.addEventListener('click', async () => {
      if (!selectedCity) return;
      console.log({selectedCity})
      const originalLabel = saveSholatLocation.textContent;
      saveSholatLocation.disabled = true;
      saveSholatLocation.textContent = 'Menyimpan...';

      // optimistic local save
      settings.sholatLocation = selectedCity;
      try {
        const res = await fetch(`${apiBaseUrl}/api/city`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({ code: String(selectedCity.id) })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Server returned ${res.status}: ${text}`);
        }

        const body = await res.json();
        const returnedCode = body?.data?.code || selectedCity.id;

        settings.notifications = settings.notifications || {};
        settings.notifications.sholat = settings.notifications.sholat || {};
        settings.notifications.sholat.code = returnedCode;
        saveSettings();

        renderSholatConfigured();
        closeModal('modal-sholat');
      } catch (err) {
        console.error('Failed to save prayer city:', err);
        // still persist locally
        settings.notifications = settings.notifications || {};
        settings.notifications.sholat = settings.notifications.sholat || {};
        settings.notifications.sholat.code = selectedCity.id;
        saveSettings();
        alert('Gagal menyimpan lokasi sholat ke server. Perubahan disimpan secara lokal.');
        renderSholatConfigured();
        closeModal('modal-sholat');
      } finally {
        saveSholatLocation.disabled = false;
        saveSholatLocation.textContent = originalLabel;
      }
    });

    // Region search
    searchRegion.addEventListener('input', (e) => {
      debouncedSearchRegions(e.target.value);
    });

    // Region result selection
    regionResults.addEventListener('click', (e) => {
      const item = e.target.closest('.search-result-item');
      if (item) {
        selectedRegion = {
          id: item.dataset.id,
          name: item.dataset.name
        };
        selectedRegionName.textContent = selectedRegion.name;
        selectedRegionEl.style.display = 'flex';
        regionResults.innerHTML = '';
        searchRegion.value = '';
        saveCuacaLocation.disabled = false;
      }
    });

    // Clear region selection
    document.querySelector('.clear-region')?.addEventListener('click', () => {
      selectedRegion = null;
      selectedRegionEl.style.display = 'none';
      saveCuacaLocation.disabled = true;
    });

    // Save cuaca location -> POST /api/region
    saveCuacaLocation.addEventListener('click', async () => {
      if (!selectedRegion) return;
      const originalLabel = saveCuacaLocation.textContent;
      saveCuacaLocation.disabled = true;
      saveCuacaLocation.textContent = 'Menyimpan...';

      settings.cuacaLocation = selectedRegion;
      try {
        const res = await fetch(`${apiBaseUrl}/api/region`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({ code: String(selectedRegion.id) })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Server returned ${res.status}: ${text}`);
        }

        const body = await res.json();
        const returnedCode = body?.data?.code || selectedRegion.id;

        settings.notifications = settings.notifications || {};
        settings.notifications.cuaca = settings.notifications.cuaca || {};
        settings.notifications.cuaca.code = returnedCode;
        saveSettings();

        renderCuacaConfigured();
        closeModal('modal-cuaca');
      } catch (err) {
        console.error('Failed to save weather region:', err);
        settings.notifications = settings.notifications || {};
        settings.notifications.cuaca = settings.notifications.cuaca || {};
        settings.notifications.cuaca.code = selectedRegion.id;
        saveSettings();
        alert('Gagal menyimpan lokasi cuaca ke server. Perubahan disimpan secara lokal.');
        renderCuacaConfigured();
        closeModal('modal-cuaca');
      } finally {
        saveCuacaLocation.disabled = false;
        saveCuacaLocation.textContent = originalLabel;
      }
    });
  }

  // Start the app
  init();
</script>
